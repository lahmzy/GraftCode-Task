# Stage 1: Build
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
WORKDIR /src
COPY ["MyEnergyService.csproj", "./"]
RUN dotnet restore "MyEnergyService.csproj"
COPY . .
RUN dotnet publish "MyEnergyService.csproj" -c Release -o /app/publish

# Stage 2: Run with Graftcode Gateway
FROM mcr.microsoft.com/dotnet/aspnet:9.0
WORKDIR /usr/app

# Install wget, python3 + python3-dev and download GG
RUN mkdir -p /usr/app \
 && apt-get update \
 && apt-get install -y \
    wget \
    python3-dev \
 && wget -O /usr/app/gg.deb \
    https://github.com/grft-dev/graftcode-gateway/releases/latest/download/gg_linux_amd64.deb \
 && dpkg -i /usr/app/gg.deb \
 && rm /usr/app/gg.deb \
 && apt-get clean \
 && rm -rf /var/lib/apt/lists/*
 
# Copy published binaries from build stage
COPY --from=build /app/publish/ /usr/app/

EXPOSE 80
EXPOSE 81

# Run Graftcode Gateway passing name of modules that should be exposed
# If GRAFT_PROJECT_KEY is set, it will be automatically picked up by gg if env var matching its config name exists, 
# or we can pass it explicitly. For now, we assume simple module exposure.
CMD ["gg", "--modules", "/usr/app/MyEnergyService.dll"]
